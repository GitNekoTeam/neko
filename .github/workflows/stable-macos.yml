name: stable-macos

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
  workflow_dispatch:
    inputs:
      force_build:
        type: boolean
        description: Force build

env:
  APP_NAME: Neko
  BINARY_NAME: neko
  OS_NAME: osx
  VSCODE_QUALITY: stable

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13
            vscode_arch: x64
          - runner: macos-14
            vscode_arch: arm64
    env:
      VSCODE_ARCH: ${{ matrix.vscode_arch }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Clone VSCode repo
        run: . get_repo.sh

      - name: Build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHOULD_BUILD: 'yes'
          CI_BUILD: 'no'
        run: ./build.sh

      - name: Prepare assets
        env:
          SHOULD_BUILD_DMG: 'no'
          SHOULD_BUILD_REH: 'no'
          SHOULD_BUILD_REH_WEB: 'no'
        run: ./prepare_assets.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neko-macos-${{ matrix.vscode_arch }}
          path: assets/*
          if-no-files-found: warn
          retention-days: 7

  universal:
    needs: build
    runs-on: macos-14
    env:
      VSCODE_ARCH: universal

    steps:
      - uses: actions/checkout@v4

      - name: Download x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: neko-macos-x64
          path: artifacts/x64

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: neko-macos-arm64
          path: artifacts/arm64

      - name: Create Universal binary
        run: |
          set -ex
          mkdir -p assets
          
          # Extract x64 and arm64 apps
          cd artifacts/x64
          unzip -q *.zip
          cd ../arm64
          unzip -q *.zip
          cd ../..
          
          # Debug: show extracted contents
          echo "x64 contents:"
          ls -la artifacts/x64/
          echo "arm64 contents:"
          ls -la artifacts/arm64/
          
          # Get version from filename
          VERSION=$(ls artifacts/x64/*.zip | sed 's/.*darwin-x64-\(.*\)\.zip/\1/')
          echo "Version: $VERSION"
          
          # Find the .app directory name
          X64_APP=$(find artifacts/x64 -maxdepth 1 -name "*.app" -type d | head -1)
          ARM64_APP=$(find artifacts/arm64 -maxdepth 1 -name "*.app" -type d | head -1)
          APP_NAME_DIR=$(basename "$ARM64_APP")
          
          echo "x64 app: $X64_APP"
          echo "arm64 app: $ARM64_APP"
          echo "App name: $APP_NAME_DIR"
          
          # Create universal app directory and copy arm64 as base
          mkdir -p universal_app
          cp -R "$ARM64_APP" universal_app/
          
          # Find and merge Mach-O binaries using lipo
          find "$X64_APP" -type f | while read x64_file; do
            rel_path="${x64_file#$X64_APP/}"
            arm64_file="$ARM64_APP/$rel_path"
            universal_file="universal_app/$APP_NAME_DIR/$rel_path"
            
            if [ -f "$arm64_file" ]; then
              if file "$x64_file" | grep -q "Mach-O"; then
                mkdir -p "$(dirname "$universal_file")"
                lipo -create "$x64_file" "$arm64_file" -output "$universal_file" 2>/dev/null || cp "$arm64_file" "$universal_file"
              fi
            fi
          done
          
          # Create universal zip
          cd universal_app
          zip -r -X -y "../assets/${APP_NAME}-darwin-universal-${VERSION}.zip" "$APP_NAME_DIR"
          cd ..
          
          echo "Universal binary created:"
          ls -la assets/

      - name: Upload universal artifact
        uses: actions/upload-artifact@v4
        with:
          name: neko-macos-universal
          path: assets/*
          if-no-files-found: warn
          retention-days: 7
